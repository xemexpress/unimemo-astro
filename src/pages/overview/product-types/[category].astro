---
import { getCollection } from "astro:content";
import ProductListView from "../../../components/ProductListView.astro";
import { PRODUCT, UI } from "../../../utils/constants";
import { ProductUtils, StringUtils, SEOUtils } from "../../../utils/coreUtils";
import ProductType404 from "../../../components/ProductType404.astro";
import type { CollectionEntry } from "astro:content";

const productType = Astro.params.category as string;

const isValidProductType = PRODUCT.ALL_TYPES.includes(productType);

let title, seoDescription, products, totalPages, page;

if (isValidProductType) {
    page = Number(Astro.url.searchParams.get("page")) || 1;
    const start = (page - 1) * UI.PRODUCTS_PER_PAGE;
    const end = start + UI.PRODUCTS_PER_PAGE;

    title = StringUtils.capitalizeFirstLetter(productType);
    seoDescription =
        SEOUtils.generateProductListCategoryDescription(productType);
    const productsByCategory = (await getCollection("products")).filter(
        (product) =>
            ProductUtils.getProductTypeFromSku(product.data.sku) === productType
    );
    products = productsByCategory
        .sort((a, b) => a.data.price - b.data.price)
        .slice(start, end);
    totalPages = Math.ceil(productsByCategory.length / UI.PRODUCTS_PER_PAGE);
}
---

{
    isValidProductType ? (
        <ProductListView
            title={title as string}
            description={seoDescription as string}
            products={products as CollectionEntry<"products">[]}
            page={page as number}
            totalPages={totalPages as number}
            byCategory={true}
        />
    ) : (
        <ProductType404 invalidProductType={productType} />
    )
}
